var fs=require("fs");var path=require("path");function File(){}File.delFile=function(e){if(fs.existsSync(e)){fs.unlinkSync(e)}};File.saveFile=function(e,l){var i=e.split(global.filedev);var o="";for(var t=0;t<i.length-1;t++)o+=i[t]+global.filedev;if(o!="")File.mkdirs(o);fs.writeFile(e,l,"utf-8")};File.mkdirs=function(e){if(!fs.existsSync(e)){var l;e.split(path.sep).forEach(function(e){if(l){l=path.join(l,e)}else{l=e}if(!fs.existsSync(l)){if(!fs.mkdirSync(l,777)){return false}}})}return true};File.isFileExist=function(e){if(!fs.existsSync(e))return false;return true};File.readUTF8File=function(e){return fs.readFileSync(e,"utf-8")};File.readUTF8FileAnsync=function(e,l,i){fs.readFile(e,"utf-8",function(e,o){if(e){i(e)}else{l(o)}})};File.readBinaryFileAnsync=function(e,l,i){fs.readFile(e,"binary",function(e,o){if(e){i(e)}else{l(o)}})};File.saveFileBinaryAnsync=function(e,l,i,o,t){t=t==undefined?"binary":t;var r=e.split(global.filedev);var a="";for(var n=0;n<r.length-1;n++)a+=r[n]+global.filedev;if(a!=""){mkdirsAn(a,511,function(r){if(r==false){console.log("创建文件夹失败:",a)}else{fs.writeFile(e,l,t,function(e){if(e){o()}else{i()}})}})}};File.readDir=function(e,l){return readdir(e).filter(l)};global.File=File;function readdir(e,l){if(l===void 0){l=""}return flatten(fs.readdirSync(e).map(function(i){var o=path.join(l,i);var t=path.join(e,i);return fs.statSync(t).isDirectory()?readdir(t,o):o}))}function flatten(e){return e.reduce(function(e,l){if(Array.isArray(l)){e.push.apply(e,flatten(l))}else{e.push(l)}return e},[])}function mkdirsAn(e,l,i){i=i||function(){};fs.exists(e,function(o){if(!o){var t;var r=e.split(path.sep);if(r[0]=="")r.shift();if(r[r.length-1]=="")r.pop();var a=r.length;var n=0;mkdir_auto_next(l,r,r.length,function(e){if(e){i(true)}else{i(false)}})}else{i(true)}})}function mkdir_auto_next(e,l,i,o,t,r){o=o||function(){};if(i>0){if(!t){t=0}if(t>=i){o(true)}else{if(r){r=path.join(r,l[t])}else{r=l[t]}if(global.filedev=="/"&&r.charAt(0)!=global.filedev)r=global.filedev+r;fs.exists(r,function(a){if(!a){fs.mkdir(r,e,function(a){if(!a){mkdir_auto_next(e,l,i,function(e){o(e)},t+1,r)}else{o(false)}})}else{mkdir_auto_next(e,l,i,function(e){o(e)},t+1,r)}})}}else{o(true)}}File.copyNextFile=function(){var e=File.copyNextFile.copyFileList.shift();if(e[0]==1){var l=e[1];var i=e[2];global.File.readBinaryFileAnsync(l,function(e){if(global.Log)global.Log.log(l+" -> "+i);File.saveFileBinaryAnsync(i,e,function(){if(File.copyNextFile.copyFileList.length==0){if(File.copyNextFile.copyComplete!=null)File.copyNextFile.copyComplete()}else{File.copyNextFile()}},function(){console.log("拷贝资源失败："+l)})},function(){console.log("拷贝资源失败："+l);if(File.copyNextFile.copyFileList.length==0){if(File.copyNextFile.copyComplete!=null)File.copyNextFile.copyComplete()}else{File.copyNextFile()}})}else{var i=e[1];var o=e[2];File.saveFileBinaryAnsync(i,o,function(){if(File.copyNextFile.copyFileList.length==0){if(File.copyNextFile.copyComplete!=null)File.copyNextFile.copyComplete()}else{File.copyNextFile()}},function(){console.log("保存资源失败："+l)},e.length>3?e[3]:undefined)}};File.copyNextFile.copyFileList=[];File.copyNextFile.copyComplete=null;File.addFileList=function(e){File.copyNextFile.copyFileList.push(e)};File.setFileListComplete=function(e){File.copyNextFile.copyComplete=e};File.clearFileList=function(){File.copyNextFile.copyFileList=[];File.copyNextFile.copyComplete=null};var fs=require("fs"),path=require("path"),File=global.File;global.filedev=process.argv[2];var version=process.argv[3];var projName=process.argv[4];var projFile=path.resolve(process.cwd(),process.argv[5]);var projType=parseInt(process.argv[6]);var srcFile,startFile,resFile;var flexFile;function readFBConfigFail(e){console.log("读取FlashBuilder项目配置文件失败，"+e.path);console.log("创建转换项目失败，请检查源项目路径是否正确，"+flexFile)}function readFBConfigComplete(e){for(var l=0;l<e.length;l++){if(e.slice(l,l+'sourceFolderPath="'.length)=='sourceFolderPath="'){for(var i=l+'sourceFolderPath="'.length;i<e.length;i++){if(e.charAt(i)=='"'){srcFile=flexFile+global.filedev+e.slice(l+'sourceFolderPath="'.length,i);break}}break}}for(var l=0;l<e.length;l++){if(e.slice(l,l+'mainApplicationPath="'.length)=='mainApplicationPath="'){for(var i=l+'mainApplicationPath="'.length;i<e.length;i++){if(e.charAt(i)=='"'){startFile=srcFile+global.filedev+e.slice(l+'mainApplicationPath="'.length,i);break}}break}}for(var l=0;l<e.length;l++){if(e.slice(l,l+'outputFolderPath="'.length)=='outputFolderPath="'){for(var i=l+'outputFolderPath="'.length;i<e.length;i++){if(e.charAt(i)=='"'){resFile=flexFile+global.filedev+e.slice(l+'outputFolderPath="'.length,i);break}}break}}saveProjectConfig()}function readFDConfigFail(e){console.log("读取FlashDevelop项目配置文件失败："+e.path);console.log("创建转换项目失败，请检查源项目路径是否正确："+flexFile)}function readFDConfigComplete(e){for(var l=0;l<e.length;l++){if(e.slice(l,l+'class path="'.length)=='class path="'){for(var i=l+'class path="'.length;i<e.length;i++){if(e.charAt(i)=='"'){srcFile=flexFile+global.filedev+e.slice(l+'class path="'.length,i);break}}break}}for(var l=0;l<e.length;l++){if(e.slice(l,l+'compile path="'.length)=='compile path="'){for(var i=l+'compile path="'.length;i<e.length;i++){if(e.charAt(i)=='"'){startFile=flexFile+global.filedev+e.slice(l+'compile path="'.length,i);break}}break}}resFile=flexFile+global.filedev+"bin";saveProjectConfig()}function saveProjectConfig(){var e={name:projName,src:srcFile,start:startFile,res:resFile,cfg:projFile+global.filedev+"config",version:version};File.addFileList([2,projFile+global.filedev+"conversion.cts",JSON.stringify(e)]);var l=File.readDir("./as3"+global.filedev+"res",function(e){return/.csv/.test(e)});for(var i=0;i<l.length;i++){File.addFileList([1,"./as3"+global.filedev+"res"+global.filedev+l[i],projFile+global.filedev+"config"+global.filedev+l[i]])}File.addFileList([1,"./as3"+global.filedev+"res"+global.filedev+"LoadingUI.ts",projFile+global.filedev+projName+global.filedev+"src"+global.filedev+"LoadingUI.ts"]);File.addFileList([1,"./as3"+global.filedev+"res"+global.filedev+"EgretMain.ts",projFile+global.filedev+"config"+global.filedev+"EgretMain.ts"]);File.addFileList([1,"./as3"+global.filedev+"res"+global.filedev+"EgretMain.ts",projFile+global.filedev+projName+global.filedev+"src"+global.filedev+"EgretMain.ts"]);File.delFile(projFile+global.filedev+projName+global.filedev+"src"+global.filedev+"Main.ts");l=File.readDir("./as3"+global.filedev+"src",function(e){return/.ts/.test(e)});for(var i=0;i<l.length;i++){File.addFileList([1,"./as3"+global.filedev+"src"+global.filedev+l[i],projFile+global.filedev+e.name+global.filedev+"src"+global.filedev+l[i]])}File.readUTF8FileAnsync(projFile+global.filedev+projName+global.filedev+"egretProperties.json",function(e){var l='"document_class":';for(i=0;i<e.length;i++){if(e.slice(i,i+l.length)==l){for(var o=i+l.length;o<e.length;o++){if(e.charAt(o)==","){e=e.slice(0,i)+l+'"EgretMain"'+e.slice(o,e.length);break}}break}}File.addFileList([2,projFile+global.filedev+projName+global.filedev+"egretProperties.json",e,"utf-8"]);File.setFileListComplete(function(){console.log("创建转换项目完毕")});File.copyNextFile()},function(e){console.log("读取Egret项目配置文件失败，"+e.path)})}if(projType==1){flexFile=path.resolve(process.cwd(),process.argv[7]);File.readUTF8FileAnsync(flexFile+global.filedev+".actionScriptProperties",readFBConfigComplete,readFBConfigFail)}else if(projType==2){flexFile=path.resolve(process.cwd(),process.argv[7]);var files=File.readDir(flexFile,function(e){return/.as3proj/.test(e)});File.readUTF8FileAnsync(flexFile+"/"+files[0],readFDConfigComplete,readFDConfigFail)}else if(projType==3){srcFile=path.resolve(process.cwd(),process.argv[7]);startFile=path.resolve(process.cwd(),process.argv[8]);resFile=path.resolve(process.cwd(),process.argv[9]);saveProjectConfig()}