var Main=function(t){function i(){t.apply(this,arguments),this.txt=new eui.Label}__extends(i,t);var s=(__define,i);return p=s.prototype,p.createChildren=function(){t.prototype.createChildren.call(this);new eui.Theme("resource/default.thm.json",this.stage);this.txt.text="链接服务器中...",this.addChild(this.txt),this.txt.x=250,this.txt.y=20;var i=new eui.Button;i.label="更新派克",this.addChild(i),i.x=20,i.y=20,i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){var t=new VByteArray;t.writeUIntV(105),GameNet.sendMessage(t)},null);var s=this;GameNet.getInstance().addEventListener("connect",this.onConnectServer,this),GameNet.registerBack(100,function(t,i){i.readUIntV()},null),GameNet.registerBack(201,function(t,i){s.txt.text=i.readUTFV()},null),GameNet.connect("192.168.2.200",9001)},p.onConnectServer=function(){this.txt.text="已连上服务器"},i}(eui.UILayer);egret.registerClass(Main,"Main");var GameNet=function(t){function i(){t.call(this),this.connectFlag=!1,this.backs={};var i=new egret.WebSocket;this.sock=i,i.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),i.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),i.addEventListener(egret.Event.CLOSE,this.onClose,this),i.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onIOError,this)}__extends(i,t);var s=(__define,i);return p=s.prototype,p.connect=function(t,i){this.sock.connect(t,i)},p.onClose=function(){this.connectFlag=!1,alert("与游戏服务器断开链接，请刷新页面")},p.onIOError=function(){alert("链接服务器错误")},p.onSocketOpen=function(){this.connectFlag=!0;var t=new VByteArray;t.writeByte(0),t.writeByte(0),t.writeByte(0),t.writeByte(0),i.sendMessage(t),console.log("链上服务器"),this.dispatchEventWith("connect"),setInterval(function(){console.log("发送心跳包");var t=new VByteArray;t.writeByte(0),t.writeByte(0),t.writeByte(0),t.writeByte(0),i.sendMessage(t)},1e4)},p.sendMessage=function(t){if(this.connectFlag){var i=new egret.ByteArray;t.writeToByteArray(i),i.position=0,this.sock.type=egret.WebSocket.TYPE_BINARY,this.sock.writeBytes(i,0,i.length),console.log("发送消息："+i.toString())}},p.onReceiveMessage=function(){var t=new egret.ByteArray;this.sock.readBytes(t,0,this.sock.bytesAvailable),t.position=0;var i=new VByteArray;i.readFromByteArray(t);var s=i.readUIntV();if(console.log("收到消息 cmd : "+s+" ,内容 ："+i.toString()),0==s){var e=(i.readUIntV(),i.readIntV());if(e>1e4)return void alert("未解析的错误")}var o=!1;if(this.backs[s])for(var n=this.backs[s],h=0;h<n.length;h++)n[h].back.apply(n[h].thisObj,[s,i]),o=!0;o||console.log("未解析的协议："+s)},p.registerBack=function(t,i,s){this.backs[t]||(this.backs[t]=[]),this.backs[t].push({back:i,thisObj:s})},i.getInstance=function(){return i.ist||(i.ist=new i),i.ist},i.connect=function(t,s){i.ist||(i.ist=new i),i.ist.connect(t,s)},i.sendMessage=function(t){i.ist||(i.ist=new i),i.ist.sendMessage(t)},i.registerBack=function(t,s,e){i.ist||(i.ist=new i),i.ist.registerBack(t,s,e)},i}(egret.EventDispatcher);egret.registerClass(GameNet,"GameNet");var VByteArray=function(){function t(i){void 0===i&&(i=!0),t.bytesTmp||(t.bytesTmp=new egret.ByteArray),this.bytes=[],this.big=i,this.position=0,this.length=0}var i=(__define,t);return p=i.prototype,p.readFromByteArray=function(t){for(this.bytes.length=0,this.position=0,this.length=0;t.bytesAvailable;)this.bytes.push(t.readByte())},p.writeToByteArray=function(t){for(var i=0;i<this.bytes.length;i++)t.writeByte(this.bytes[i])},p.writeIntV=function(t){t>=0?t*=2:(t=~t,t*=2,t++),this.writeUIntV(t)},p.writeUIntV=function(t){var i=!1;t=0>t?-t:t;var s=0;t>=268435456&&(s=t/268435456,t=268435455&t,i=!0),i||t>>7?(this.bytes.splice(this.position,0,128|127&t),this.position++,this.length++):(this.bytes.splice(this.position,0,127&t),this.position++,this.length++),i||t>>14?(this.bytes.splice(this.position,0,128|t>>7&127),this.position++,this.length++):t>>7&&(this.bytes.splice(this.position,0,t>>7&127),this.position++,this.length++),i||t>>21?(this.bytes.splice(this.position,0,128|t>>14&127),this.position++,this.length++):t>>14&&(this.bytes.splice(this.position,0,t>>14&127),this.position++,this.length++),i||t>>28?(this.bytes.splice(this.position,0,128|t>>21&127),this.position++,this.length++):t>>21&&(this.bytes.splice(this.position,0,t>>21&127),this.position++,this.length++),i&&this.writeUIntV(Math.floor(s))},p.writeInt=function(t){var i=t>=0?!0:!1;t=t>=0?t:2147483648+t,t=4294967295&t;var s=this.big,e=this.bytes;s?(e.splice(this.position,0,(i?0:128)+(t>>24)),e.splice(this.position,0,t>>16&255),e.splice(this.position,0,t>>8&255),e.splice(this.position,0,255&t)):(e.splice(this.position,0,255&t),e.splice(this.position,0,t>>8&255),e.splice(this.position,0,t>>16&255),e.splice(this.position,0,(i?0:128)+(t>>24))),this.length+=4,this.position+=4},p.writeInt64=function(t){var i=t>=0?!0:!1;t=t>=0?t:0x8000000000000000+t,t=4294967295&t;var s=this.big,e=this.bytes;s?(e.splice(this.position,0,(i?0:128)+(t>>56)),e.splice(this.position,0,t>>48&255),e.splice(this.position,0,t>>40&255),e.splice(this.position,0,t>>32&255),e.splice(this.position,0,t>>24&255),e.splice(this.position,0,t>>16&255),e.splice(this.position,0,t>>8&255),e.splice(this.position,0,255&t)):(e.splice(this.position,0,255&t),e.splice(this.position,0,t>>8&255),e.splice(this.position,0,t>>16&255),e.splice(this.position,0,t>>24&255),e.splice(this.position,0,t>>32&255),e.splice(this.position,0,t>>40&255),e.splice(this.position,0,t>>48&255),e.splice(this.position,0,(i?0:128)+(t>>56))),this.length+=8,this.position+=8},p.writeByte=function(t){this.bytes.splice(this.position,0,t),this.length+=1,this.position+=1},p.writeboolean=function(t){this.bytes.splice(this.position,0,1==t?1:0),this.length+=1,this.position+=1},p.writeUnsignedInt=function(t){var i=this.bytes;this.big?(i.splice(this.position,0,t>>24),i.splice(this.position,0,t>>16&255),i.splice(this.position,0,t>>8&255),i.splice(this.position,0,255&t)):(i.splice(this.position,0,255&t),i.splice(this.position,0,t>>8&255),i.splice(this.position,0,t>>16&255),i.splice(this.position,0,t>>24)),this.length+=4,this.position+=4},p.writeShort=function(t){t=65535&t;var i=this.bytes;this.big?(i.splice(this.position,0,t>>8&255),i.splice(this.position,0,255&t)):(i.splice(this.position,0,255&t),i.splice(this.position,0,t>>8&255)),this.length+=2,this.position+=2},p.writeUnsignedShort=function(t){t=65535&t,this.big?(this.bytes.splice(this.position,0,t>>8&255),this.bytes.splice(this.position,0,255&t)):(this.bytes.splice(this.position,0,255&t),this.bytes.splice(this.position,0,t>>8&255)),this.length+=2,this.position+=2},p.writeUTF=function(i){var s=t.stringToBytes(i);this.writeShort(s.length);for(var e=0;e<s.length;e++)this.bytes.splice(this.position,0,s[e]),this.position++;this.length+=s.length},p.writeUTFV=function(i){var s=t.stringToBytes(i);this.writeUIntV(s.length);for(var e=0;e<s.length;e++)this.bytes.splice(this.position,0,s[e]),this.position++;this.length+=s.length},p.writeUTFBytes=function(i,s){for(var e=t.stringToBytes(i),o=0;s>o;o++)o<e.length?this.bytes.splice(this.position,0,e[o]):this.bytes.splice(this.position,0,0),this.position++;this.length+=s},p.writeBytes=function(t,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this.length+=s},p.readboolean=function(){var t=0==this.bytes[this.position]?!1:!0;return this.position+=1,t},p.readIntV=function(){var t=this.readUIntV();return t%2==1?(t=Math.floor(t/2),t=~t):t=Math.floor(t/2),t},p.readUIntV=function(){var t=0;return t+=127&this.bytes[this.position],this.bytes[this.position]>>7&&(this.position++,t+=(127&this.bytes[this.position])<<7,this.bytes[this.position]>>7&&(this.position++,t+=(127&this.bytes[this.position])<<14,this.bytes[this.position]>>7&&(this.position++,t+=(127&this.bytes[this.position])<<21,this.bytes[this.position]>>7&&(this.position++,t+=16*((127&this.bytes[this.position])<<24),this.bytes[this.position]>>7&&(this.position++,t+=2048*((127&this.bytes[this.position])<<24),this.bytes[this.position]>>7&&(this.position++,t+=262144*(this.bytes[this.position]<<24))))))),this.position++,t},p.readInt=function(){var t=0,i=this.bytes;return t=this.big?i[this.position]|i[this.position+1]<<8|i[this.position+2]<<16|i[this.position+3]<<24:i[this.position+3]|i[this.position+2]<<8|i[this.position+1]<<16|i[this.position]<<24,this.position+=4,t},p.readInt64=function(){var t=0,i=this.bytes;return t=this.big?i[this.position]|i[this.position+1]<<8|i[this.position+2]<<16|i[this.position+3]<<24|i[this.position+4]<<32|i[this.position+5]<<40|i[this.position+6]<<48|i[this.position+7]<<56:i[this.position+7]|i[this.position+6]<<8|i[this.position+5]<<16|i[this.position+4]<<24|i[this.position+3]<<32|i[this.position+2]<<40|i[this.position+1]<<48|i[this.position]<<56,this.position+=8,t},p.readUnsignedInt=function(){var t=0,i=this.bytes;return t=this.big?i[this.position]|i[this.position+1]<<8|i[this.position+2]<<16|i[this.position+3]<<24:i[this.position+3]|i[this.position+2]<<8|i[this.position+1]<<16|i[this.position]<<24,this.position+=4,t},p.readByte=function(){var t=this.bytes[this.position];return this.position+=1,t},p.readShort=function(){var t,i=this.bytes;return t=this.big?i[this.position]|i[this.position+1]<<8:i[this.position]<<8|i[this.position+1],t>32768&&(t-=65536),this.position+=2,t},p.readUnsignedShort=function(){var t;return t=this.big?this.bytes[this.position]|this.bytes[this.position+1]<<8:this.bytes[this.position]<<8|this.bytes[this.position+1],t>32768&&(t-=65536),this.position+=2,t},p.readUTF=function(){var i=this.readShort(),s=t.bytesToString(this.bytes.slice(this.position,this.position+i));return this.position+=i,s},p.readUTFV=function(){var i=this.readUIntV(),s=t.bytesToString(this.bytes.slice(this.position,this.position+i));return this.position+=i,s},p.readUTFBytes=function(i){var s=t.bytesToString(this.bytes.slice(this.position,this.position+i));return this.position+=i,s},p.bytesAvailable=function(){return this.length-this.position},p.toString=function(){for(var t="",i=0;i<this.bytes.length;i++)t+=this.bytes[i]+(i<this.bytes.length-1?",":"");return t},t.stringToBytes=function(i){var s=[],e=t.bytesTmp;e.position=0,e.length=0,e.writeUTFBytes(i),e.position=0;for(var o=0;o<e.length;o++)s.push(e.readByte());return s},t.bytesToString=function(i){var s=t.bytesTmp;s.position=0,s.length=0;for(var e=0;e<i.length;e++)s.writeByte(i[e]);return s.position=0,s.readUTFBytes(s.bytesAvailable)},t}();egret.registerClass(VByteArray,"VByteArray");